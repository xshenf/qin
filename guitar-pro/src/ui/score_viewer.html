<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Score Viewer</title>

    <!-- Qt WebChannel -->
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #1e1e2e;
            color: #e0e0e0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ========== åŠ è½½å±‚ ========== */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background: #1e1e2e;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.4s ease;
        }

        #loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-icon {
            font-size: 64px;
            margin-bottom: 20px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.7;
            }

            50% {
                transform: scale(1.1);
                opacity: 1;
            }
        }

        .loading-title {
            font-size: 18px;
            font-weight: 600;
            color: #cdd6f4;
            margin-bottom: 16px;
        }

        .loading-status {
            font-size: 13px;
            color: #7f849c;
            margin-bottom: 12px;
            min-height: 20px;
        }

        /* è¿›åº¦æ¡ */
        .progress-bar-container {
            width: 280px;
            height: 4px;
            background: #313244;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #89b4fa, #74c7ec);
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* ========== å ä½ä¿¡æ¯ ========== */
        #placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #585b70;
            z-index: 10;
            user-select: none;
        }

        #placeholder.hidden {
            display: none;
        }

        .placeholder-icon {
            font-size: 72px;
            margin-bottom: 16px;
            opacity: 0.6;
        }

        .placeholder-text {
            font-size: 16px;
            text-align: center;
            line-height: 1.8;
        }

        .placeholder-hint {
            font-size: 12px;
            color: #45475a;
            margin-top: 8px;
        }

        /* æ‹–æ”¾é«˜äº® */
        .drag-over #placeholder {
            background: rgba(137, 180, 250, 0.05);
            border: 2px dashed #89b4fa;
        }

        /* ========== ä¹è°±å®¹å™¨ ========== */
        #score-container {
            flex: 1;
            width: 100%;
            overflow-y: auto;
            overflow-x: auto;
            background: #ffffff;
            position: relative;
        }

        /* AlphaTab æ ·å¼è¦†ç›– */
        .at-surface {
            background: #ffffff !important;
        }

        .at-main {
            background: #ffffff !important;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        #score-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        #score-container::-webkit-scrollbar-track {
            background: #f0f0f0;
        }

        #score-container::-webkit-scrollbar-thumb {
            background: #bbb;
            border-radius: 4px;
        }

        #score-container::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        /* ========== åº•éƒ¨ä¿¡æ¯æ  ========== */
        #score-info {
            background: #181825;
            padding: 4px 12px;
            font-size: 12px;
            color: #7f849c;
            border-top: 1px solid #313244;
            display: none;
            gap: 16px;
            align-items: center;
            flex-shrink: 0;
        }

        #score-info.visible {
            display: flex;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .info-label {
            color: #585b70;
        }

        .info-value {
            color: #cdd6f4;
        }

        .info-separator {
            color: #313244;
        }

        /* ========== é”™è¯¯æç¤º ========== */
        #error-banner {
            display: none;
            background: #45273a;
            color: #f38ba8;
            padding: 10px 16px;
            font-size: 13px;
            border-bottom: 1px solid #5e3a50;
            align-items: center;
            gap: 8px;
        }

        #error-banner.visible {
            display: flex;
        }

        #error-banner .error-dismiss {
            margin-left: auto;
            cursor: pointer;
            background: none;
            border: 1px solid #f38ba8;
            color: #f38ba8;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
        }

        #error-banner .error-dismiss:hover {
            background: rgba(243, 139, 168, 0.1);
        }

        /* ========== æ¸²æŸ“è¿›åº¦ï¼ˆåº•éƒ¨æ¡ï¼‰ ========== */
        #render-progress {
            height: 2px;
            background: #313244;
            flex-shrink: 0;
            display: none;
        }

        #render-progress.visible {
            display: block;
        }

        #render-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #a6e3a1, #94e2d5);
            width: 0%;
            transition: width 0.2s ease;
        }

        /* ========== æ’­æ”¾å™¨å…‰æ ‡ä¸é«˜äº® ========== */
        .at-cursor-bar {
            /* å½“å‰å°èŠ‚èƒŒæ™¯é«˜äº®ï¼ˆå¯é€‰ï¼Œå¤ªå¼ºå¯èƒ½ä¼šå¹²æ‰°è§†çº¿ï¼‰ */
            background: rgba(255, 255, 0, 0.05);
        }

        .at-cursor-beat {
            /* å½“å‰æ‹å­é«˜äº®ï¼šè“è‰²åŠé€æ˜èƒŒæ™¯ */
            background: rgba(64, 168, 255, 0.25);
            border-radius: 2px;
        }

        .at-highlight {
            /* æ’­æ”¾è¿‡çš„éŸ³ç¬¦å˜è‰²ï¼ˆAlphaTab é»˜è®¤å¯èƒ½ä¸åŠ è¿™ä¸ªç±»ï¼Œå–å†³äºé…ç½®ï¼‰ */
            fill: #0078ff;
            stroke: #0078ff;
        }
    </style>
</head>

<body>

    <!-- åŠ è½½å±‚ï¼ˆAlphaTab åˆå§‹åŒ–ä¸­ï¼‰ -->
    <div id="loading-overlay">
        <div class="loading-icon">ğŸ¼</div>
        <div class="loading-title">æ­£åœ¨åˆå§‹åŒ–ä¹è°±å¼•æ“...</div>
        <div class="loading-status" id="loading-status">åŠ è½½ AlphaTab æ ¸å¿ƒåº“</div>
        <div class="progress-bar-container">
            <div class="progress-bar" id="loading-progress"></div>
        </div>
    </div>

    <!-- é”™è¯¯æç¤ºæ¡ -->
    <div id="error-banner">
        <span>âš ï¸</span>
        <span id="error-message">åŠ è½½å¤±è´¥</span>
        <button class="error-dismiss" onclick="dismissError()">å…³é—­</button>
    </div>

    <!-- æ¸²æŸ“è¿›åº¦æ¡ -->
    <div id="render-progress">
        <div id="render-progress-bar"></div>
    </div>

    <!-- å ä½ä¿¡æ¯ -->
    <div id="placeholder">
        <div class="placeholder-icon">ğŸ¸</div>
        <div class="placeholder-text">
            æ‹–æ”¾ä¹è°±æ–‡ä»¶åˆ°æ­¤å¤„<br>
            æˆ–ä½¿ç”¨å·¥å…·æ ã€ŒğŸ“‚ æ‰“å¼€ä¹è°±ã€æŒ‰é’®
        </div>
        <div class="placeholder-hint">
            æ”¯æŒæ ¼å¼ï¼šGP3 / GP4 / GP5 / GPX / GP / MusicXML / MIDI
        </div>
    </div>

    <!-- ä¹è°±æ¸²æŸ“å®¹å™¨ -->
    <div id="score-container"></div>

    <!-- åº•éƒ¨ä¿¡æ¯æ  -->
    <div id="score-info">
        <span class="info-item">
            <span class="info-label">æ›²å:</span>
            <span class="info-value" id="info-title">--</span>
        </span>
        <span class="info-separator">|</span>
        <span class="info-item">
            <span class="info-label">è‰ºæœ¯å®¶:</span>
            <span class="info-value" id="info-artist">--</span>
        </span>
        <span class="info-separator">|</span>
        <span class="info-item">
            <span class="info-value" id="info-tempo">--</span>
        </span>
        <span class="info-separator">|</span>
        <span class="info-item">
            <span class="info-value" id="info-position">--</span>
        </span>
        <span style="margin-left: auto;" class="info-item">
            <span class="info-label">å°èŠ‚:</span>
            <span class="info-value" id="info-bar">--</span>
        </span>
    </div>

    <script>
        // ==== å…¨å±€çŠ¶æ€ ====
        let api = null;
        let pyBridge = null;
        let currentZoom = 1.0;
        let totalBars = 0;

        // ==== åŠ è½½çŠ¶æ€ç®¡ç† ====
        const LoadState = {
            LOADING_LIB: 'loading_lib',
            INIT_ENGINE: 'init_engine',
            LOADING_SOUNDFONT: 'loading_soundfont',
            READY: 'ready',
            ERROR: 'error',
        };

        function setLoadingStatus(text, progress) {
            const statusEl = document.getElementById('loading-status');
            const progressEl = document.getElementById('loading-progress');
            if (statusEl) statusEl.textContent = text;
            if (progressEl) progressEl.style.width = progress + '%';
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.add('hidden');
            // ç­‰åŠ¨ç”»ç»“æŸåç§»é™¤ DOM
            setTimeout(() => overlay.remove(), 500);
        }

        function showError(message) {
            const banner = document.getElementById('error-banner');
            const msgEl = document.getElementById('error-message');
            msgEl.textContent = message;
            banner.classList.add('visible');
            notifyPython('error', { message: message });
        }

        function dismissError() {
            document.getElementById('error-banner').classList.remove('visible');
        }

        // ==== Qt WebChannel æ¡¥æ¥ ====
        function initBridge() {
            return new Promise((resolve) => {
                if (typeof QWebChannel === 'undefined') {
                    console.warn('QWebChannel not available, running standalone');
                    resolve(null);
                    return;
                }
                new QWebChannel(qt.webChannelTransport, (channel) => {
                    pyBridge = channel.objects.bridge;
                    console.log('Python bridge connected');
                    resolve(pyBridge);
                });
            });
        }

        // ==== é€šçŸ¥ Python ç«¯ ====
        function notifyPython(event, data) {
            if (pyBridge && pyBridge.onJsEvent) {
                pyBridge.onJsEvent(event, JSON.stringify(data || {}));
            }
        }

        // ==== åŠ¨æ€åŠ è½½ AlphaTab JS ====
        function loadAlphaTabScript() {
            return new Promise((resolve, reject) => {
                setLoadingStatus('åŠ è½½ AlphaTab æ ¸å¿ƒåº“...', 10);

                // ä¼˜å…ˆå°è¯•æœ¬åœ°æ–‡ä»¶
                const localPath = 'vendor/alphatab/alphaTab.min.js';
                const cdnPath = 'https://cdn.jsdelivr.net/npm/@coderline/alphatab@1.3.1/dist/alphaTab.min.js';

                const script = document.createElement('script');
                script.onload = () => {
                    console.log('[AlphaTab] JS åº“åŠ è½½æˆåŠŸ');
                    setLoadingStatus('æ ¸å¿ƒåº“å·²å°±ç»ª', 30);
                    resolve();
                };
                script.onerror = () => {
                    console.warn('[AlphaTab] æœ¬åœ°åŠ è½½å¤±è´¥ï¼Œå°è¯• CDN...');
                    setLoadingStatus('æœ¬åœ°åŠ è½½å¤±è´¥ï¼Œå°è¯•åœ¨çº¿åŠ è½½...', 15);
                    // å›é€€åˆ° CDN
                    const fallback = document.createElement('script');
                    fallback.onload = () => {
                        console.log('[AlphaTab] CDN JS åº“åŠ è½½æˆåŠŸ');
                        setLoadingStatus('æ ¸å¿ƒåº“å·²å°±ç»ªï¼ˆåœ¨çº¿ï¼‰', 30);
                        resolve();
                    };
                    fallback.onerror = () => {
                        reject(new Error('AlphaTab JS åŠ è½½å¤±è´¥ï¼šæ— æ³•è®¿é—®æœ¬åœ°æ–‡ä»¶æˆ–åœ¨çº¿ CDN'));
                    };
                    fallback.src = cdnPath;
                    document.head.appendChild(fallback);
                };
                script.src = localPath;
                document.head.appendChild(script);
            });
        }

        // ==== è·å–èµ„æºè·¯å¾„ï¼ˆæœ¬åœ°ä¼˜å…ˆï¼ŒCDN å›é€€ï¼‰ ====
        function getResourcePath(type) {
            const localBase = 'vendor/alphatab/';
            const cdnBase = 'https://cdn.jsdelivr.net/npm/@coderline/alphatab@1.3.1/dist/';

            // ç®€å•æ£€æµ‹ï¼šå¦‚æœ AlphaTab æ˜¯ä»æœ¬åœ°åŠ è½½çš„å°±ç”¨æœ¬åœ°è·¯å¾„
            // å¦åˆ™ç”¨ CDN è·¯å¾„
            const scripts = document.querySelectorAll('script[src]');
            let isLocal = false;
            scripts.forEach(s => {
                if (s.src.includes('vendor/alphatab')) isLocal = true;
            });

            if (type === 'font') {
                return isLocal ? localBase + 'font/' : cdnBase + 'font/';
            } else if (type === 'soundfont') {
                return isLocal
                    ? localBase + 'soundfont/sonivox.sf2'
                    : cdnBase + 'soundfont/sonivox.sf2';
            }
        }

        // ==== AlphaTab åˆå§‹åŒ– ====
        function initAlphaTab() {
            setLoadingStatus('åˆå§‹åŒ–æ¸²æŸ“å¼•æ“...', 40);

            const container = document.getElementById('score-container');

            const settings = {
                core: {
                    fontDirectory: getResourcePath('font'),
                    useWorkers: true,
                    logLevel: 1, // Warning çº§åˆ«
                },
                player: {
                    enablePlayer: true,
                    enableCursor: true,
                    enableAnimatedBeatCursor: true,
                    enableElementHighlighting: true,
                    soundFont: getResourcePath('soundfont'),
                    scrollElement: container,
                    scrollMode: 'off', // 'off' ä¸ºç¿»é¡µæ»šåŠ¨ï¼Œ'continuous' ä¸ºå¹³æ»‘æ»šåŠ¨
                    scrollSpeed: 300,
                    scrollOffsetY: -20, // æ»šåŠ¨æ—¶çš„å‚ç›´åç§»ï¼ˆç•™å‡ºé¡¶éƒ¨ç©ºé—´ï¼‰
                },
                display: {
                    staveProfile: 'Tab',       // é»˜è®¤å…­çº¿è°±
                    scale: currentZoom,
                    layoutMode: 'Page',        // é»˜è®¤é¡µé¢è§†å›¾
                    resources: {
                        // ä¹è°±åŒºåŸŸä¿æŒç™½åº•ä»¥ç¡®ä¿å¯è¯»æ€§
                    }
                },
                notation: {
                    elements: {
                        scoreTitle: true,
                        scoreSubTitle: true,
                        scoreArtist: true,
                        scoreAlbum: true,
                        scoreWords: true,
                        scoreMusic: true,
                        scoreCopyright: true,
                    }
                }
            };

            api = new alphaTab.AlphaTabApi(container, settings);

            // ---- äº‹ä»¶ç›‘å¬ ----

            // ä¹è°±åŠ è½½å®Œæˆ
            api.scoreLoaded.on((score) => {
                document.getElementById('placeholder').classList.add('hidden');
                document.getElementById('score-info').classList.add('visible');
                document.getElementById('info-title').textContent = score.title || 'æœªå‘½å';
                document.getElementById('info-artist').textContent = score.artist || 'æœªçŸ¥';
                document.getElementById('info-tempo').textContent = `â™©=${score.tempo}`;

                // è®¡ç®—æ€»å°èŠ‚æ•°
                if (score.tracks && score.tracks.length > 0) {
                    totalBars = score.tracks[0].staves[0].bars.length;
                    document.getElementById('info-bar').textContent = `1 / ${totalBars}`;
                }

                notifyPython('scoreLoaded', {
                    title: score.title,
                    artist: score.artist,
                    tempo: score.tempo,
                    tracks: score.tracks.length,
                    bars: totalBars,
                });
            });

            // æ¸²æŸ“å¼€å§‹/å®Œæˆ
            api.renderStarted.on(() => {
                document.getElementById('render-progress').classList.add('visible');
                document.getElementById('render-progress-bar').style.width = '30%';
                notifyPython('renderProgress', { progress: 0 });
            });

            api.renderFinished.on(() => {
                document.getElementById('render-progress-bar').style.width = '100%';
                setTimeout(() => {
                    document.getElementById('render-progress').classList.remove('visible');
                    document.getElementById('render-progress-bar').style.width = '0%';
                }, 500);
                notifyPython('renderProgress', { progress: 100 });
            });

            // æ’­æ”¾å™¨å°±ç»ª
            api.playerReady.on(() => {
                notifyPython('playerReady', {});
            });

            // æ’­æ”¾å®Œæˆ
            api.playerFinished.on(() => {
                notifyPython('playerFinished', {});
            });

            // å½“å‰æ‹å­å˜åŒ–
            api.playedBeatChanged.on((beat) => {
                if (beat && beat.notes) {
                    const notes = beat.notes.map(n => ({
                        id: n.id,
                        fret: n.value,
                        string: n.string,
                        startTick: beat.start,
                        duration: beat.duration,
                    }));

                    // æ›´æ–°å½“å‰å°èŠ‚å·
                    if (beat.voice && beat.voice.bar) {
                        const barIdx = beat.voice.bar.index + 1;
                        document.getElementById('info-bar').textContent = `${barIdx} / ${totalBars}`;
                    }

                    notifyPython('beatChanged', { notes: notes });
                }
            });

            // æ’­æ”¾ä½ç½®å˜åŒ–
            api.playerPositionChanged.on((e) => {
                const pos = `${formatTime(e.currentTime)} / ${formatTime(e.endTime)}`;
                document.getElementById('info-position').textContent = pos;
                notifyPython('positionChanged', {
                    currentTime: e.currentTime,
                    endTime: e.endTime,
                    currentTick: e.currentTick,
                    endTick: e.endTick,
                });
            });

            // SoundFont åŠ è½½è¿›åº¦
            api.soundFontLoad.on((e) => {
                const pct = Math.round((e.loaded / e.total) * 100);
                setLoadingStatus(`åŠ è½½éŸ³è‰²åº“... ${pct}%`, 50 + pct * 0.4);
            });

            api.soundFontLoaded.on(() => {
                setLoadingStatus('éŸ³è‰²åº“åŠ è½½å®Œæˆ', 95);
            });

            // å¼•æ“å°±ç»ªåéšè—åŠ è½½å±‚
            api.playerReady.on(() => {
                setLoadingStatus('å‡†å¤‡å°±ç»ª', 100);
                setTimeout(hideLoadingOverlay, 300);
            });

            // å¦‚æœä¸éœ€è¦æ’­æ”¾å™¨ï¼Œæ¸²æŸ“å®Œæˆåå°±éšè—
            api.renderFinished.on(() => {
                // å¦‚æœåŠ è½½å±‚è¿˜åœ¨ï¼Œå»¶è¿Ÿéšè—
                const overlay = document.getElementById('loading-overlay');
                if (overlay && !overlay.classList.contains('hidden')) {
                    setTimeout(() => {
                        if (!overlay.classList.contains('hidden')) {
                            setLoadingStatus('æ¸²æŸ“å®Œæˆ', 100);
                            setTimeout(hideLoadingOverlay, 300);
                        }
                    }, 2000);
                }
            });

            // é”™è¯¯å¤„ç†
            api.error.on((e) => {
                console.error('[AlphaTab] Error:', e);
                const msg = e.message || e.type || 'æ¸²æŸ“å‡ºé”™';
                showError(msg);
            });

            setLoadingStatus('å¼•æ“åˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…éŸ³è‰²åº“...', 50);
            console.log('[AlphaTab] å¼•æ“å·²åˆå§‹åŒ–');
        }

        function formatTime(ms) {
            const s = Math.floor(ms / 1000);
            const m = Math.floor(s / 60);
            return `${m}:${String(s % 60).padStart(2, '0')}`;
        }

        // ==== JS APIï¼ˆä¾› Python è°ƒç”¨ï¼‰ ====

        // åŠ è½½ä¹è°±æ–‡ä»¶ï¼ˆé€šè¿‡ URLï¼‰
        window.loadScore = function (url) {
            if (!api) return;
            dismissError();
            // æœ¬åœ°æ–‡ä»¶è·¯å¾„è½¬ file:// URL
            if (url.match(/^[A-Za-z]:\\/)) {
                url = 'file:///' + url.replace(/\\/g, '/');
            }
            try {
                api.load(url);
            } catch (e) {
                showError(`åŠ è½½å¤±è´¥: ${e.message}`);
            }
        };

        // ä» Base64 æ•°æ®åŠ è½½
        window.loadScoreData = function (base64Data) {
            if (!api) return;
            dismissError();
            try {
                const binary = atob(base64Data);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    bytes[i] = binary.charCodeAt(i);
                }
                api.load(bytes.buffer);
            } catch (e) {
                showError(`æ•°æ®åŠ è½½å¤±è´¥: ${e.message}`);
            }
        };

        // æ’­æ”¾/æš‚åœ
        window.playPause = function () {
            if (api) api.playPause();
        };

        // åœæ­¢
        window.stop = function () {
            if (api) api.stop();
        };

        // è®¾ç½®é€Ÿåº¦æ¯”ä¾‹
        window.setPlaybackSpeed = function (speed) {
            if (api) api.playbackSpeed = speed;
        };

        // è®¾ç½®éŸ³é‡
        window.setMasterVolume = function (vol) {
            if (api) api.masterVolume = vol;
        };

        // é€‰æ‹©è½¨é“
        window.setTrack = function (trackIndex) {
            if (api && api.score && api.score.tracks[trackIndex]) {
                api.renderTracks([api.score.tracks[trackIndex]]);
            }
        };

        // è®¾ç½®æ˜¾ç¤ºæ¨¡å¼ï¼ˆTab / Score / ScoreTabï¼‰
        window.setStaveProfile = function (profile) {
            if (api) {
                api.settings.display.staveProfile = profile;
                api.updateSettings();
                api.render();
            }
        };

        // ---- æ–°å¢ API ----

        // ç¼©æ”¾æ§åˆ¶ï¼ˆ0.5 ~ 2.0ï¼‰
        window.setZoom = function (scale) {
            if (!api) return;
            scale = Math.max(0.5, Math.min(2.0, scale));
            currentZoom = scale;
            api.settings.display.scale = scale;
            api.updateSettings();
            api.render();
            notifyPython('zoomChanged', { zoom: scale });
        };

        // è·å–å½“å‰ç¼©æ”¾
        window.getZoom = function () {
            return currentZoom;
        };

        // å¸ƒå±€æ¨¡å¼åˆ‡æ¢ï¼ˆPage / Horizontalï¼‰
        window.setLayoutMode = function (mode) {
            if (!api) return;
            // AlphaTab layoutMode: 0 = Page, 1 = Horizontal
            let layoutValue;
            if (mode === 'Horizontal' || mode === 1) {
                layoutValue = 1;
            } else {
                layoutValue = 0; // Page
            }
            api.settings.display.layoutMode = layoutValue;
            api.updateSettings();
            api.render();
            notifyPython('layoutModeChanged', { mode: mode });
        };

        // å°èŠ‚è·³è½¬ï¼ˆ1-indexedï¼‰
        window.goToBar = function (barIndex) {
            if (!api || !api.score) return;
            if (barIndex < 1 || barIndex > totalBars) return;

            // é€šè¿‡ AlphaTab çš„ API è·³è½¬åˆ°æŒ‡å®šå°èŠ‚
            const track = api.score.tracks[0];
            if (track && track.staves[0] && track.staves[0].bars[barIndex - 1]) {
                const bar = track.staves[0].bars[barIndex - 1];
                if (bar.voices[0] && bar.voices[0].beats[0]) {
                    const beat = bar.voices[0].beats[0];
                    api.tickPosition = beat.absoluteStart;
                    document.getElementById('info-bar').textContent = `${barIndex} / ${totalBars}`;
                }
            }
        };

        // è·å–ä¹è°±ä¿¡æ¯
        window.getScoreInfo = function () {
            if (!api || !api.score) return null;
            const score = api.score;
            return {
                title: score.title,
                artist: score.artist,
                tempo: score.tempo,
                tracks: score.tracks.length,
                bars: totalBars,
            };
        };

        // æ ‡è®°éŸ³ç¬¦é¢œè‰²ï¼ˆç»ƒä¹ åé¦ˆï¼‰
        window.markNote = function (noteId, color) {
            const noteEl = document.querySelector(`[data-note-id="${noteId}"]`);
            if (noteEl) {
                noteEl.style.fill = color;
            }
        };

        // ==== æ‹–æ”¾æ”¯æŒ ====
        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            document.body.classList.add('drag-over');
        });

        document.addEventListener('dragleave', (e) => {
            e.preventDefault();
            document.body.classList.remove('drag-over');
        });

        document.addEventListener('drop', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            document.body.classList.remove('drag-over');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                // æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
                const ext = file.name.split('.').pop().toLowerCase();
                const supported = ['gp3', 'gp4', 'gp5', 'gpx', 'gp', 'musicxml', 'mxl', 'xml', 'mid', 'midi'];
                if (!supported.includes(ext)) {
                    showError(`ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: .${ext}ã€‚è¯·ä½¿ç”¨ GP3/GP4/GP5/GPX/MusicXML/MIDI æ ¼å¼ã€‚`);
                    return;
                }
                try {
                    const buffer = await file.arrayBuffer();
                    api.load(buffer);
                    notifyPython('fileDropped', { name: file.name, size: file.size });
                } catch (err) {
                    showError(`æ–‡ä»¶åŠ è½½å¤±è´¥: ${err.message}`);
                }
            }
        });

        // ==== é”®ç›˜å¿«æ·é”® ====
        document.addEventListener('keydown', (e) => {
            if (!api) return;

            switch (e.key) {
                case ' ':  // ç©ºæ ¼ï¼šæ’­æ”¾/æš‚åœ
                    e.preventDefault();
                    api.playPause();
                    break;
                case '+':  // æ”¾å¤§
                case '=':
                    if (e.ctrlKey) {
                        e.preventDefault();
                        setZoom(currentZoom + 0.1);
                    }
                    break;
                case '-':  // ç¼©å°
                    if (e.ctrlKey) {
                        e.preventDefault();
                        setZoom(currentZoom - 0.1);
                    }
                    break;
                case '0':  // é‡ç½®ç¼©æ”¾
                    if (e.ctrlKey) {
                        e.preventDefault();
                        setZoom(1.0);
                    }
                    break;
            }
        });

        // ==== å¯åŠ¨ ====
        (async () => {
            try {
                await initBridge();
                setLoadingStatus('åŠ è½½ AlphaTab å¼•æ“...', 20);

                await loadAlphaTabScript();
                initAlphaTab();
                notifyPython('ready', {});
            } catch (err) {
                console.error('[å¯åŠ¨å¤±è´¥]', err);
                setLoadingStatus('åŠ è½½å¤±è´¥', 0);
                // æ˜¾ç¤ºé”™è¯¯åœ¨åŠ è½½å±‚
                const overlay = document.getElementById('loading-overlay');
                if (overlay) {
                    const title = overlay.querySelector('.loading-title');
                    const status = overlay.querySelector('.loading-status');
                    title.textContent = 'âŒ åˆå§‹åŒ–å¤±è´¥';
                    title.style.color = '#f38ba8';
                    status.textContent = err.message || 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æœ¬åœ°èµ„æº';
                    status.style.color = '#f38ba8';
                }
                notifyPython('error', { message: err.message || 'åˆå§‹åŒ–å¤±è´¥' });
            }
        })();
    </script>

</body>

</html>