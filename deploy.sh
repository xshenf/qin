#!/bin/bash
# ------------------------------------------------------------------
# Qin Guitar App - ç®€æ˜“å¿«æ·éƒ¨ç½²è„šæœ¬ (é€‚ç”¨äº Linux äº‘æœåŠ¡å™¨)
# ------------------------------------------------------------------
# ä½¿ç”¨æ–¹æ³•ï¼šå°†æ•´ä¸ªä»£ç åº“(åŒ…å«appå’Œserver)ä¼ åˆ°æœåŠ¡å™¨åï¼Œåœ¨æ ¹ç›®å½•æ‰§è¡Œï¼š
# chmod +x deploy.sh
# ./deploy.sh
# ------------------------------------------------------------------

echo "=========================================="
echo "å¼€å§‹éƒ¨ç½² Qin å‰ä»–åº”ç”¨..."
echo "=========================================="

# 1. æ£€æŸ¥ node å’Œ npm
if ! command -v node &> /dev/null; then
    echo "âŒ æœªæ£€æµ‹åˆ° Node.jsï¼Œè¯·å…ˆå®‰è£… Node.js (æ¨è v18+)"
    exit 1
fi

# 2. æ£€æŸ¥ pm2 (è¿›ç¨‹å®ˆæŠ¤)
if ! command -v pm2 &> /dev/null; then
    echo "ğŸ“¦ æ­£åœ¨å…¨å±€å®‰è£… pm2..."
    npm install -g pm2
fi

# 3. æ£€æŸ¥ pnpm (ç”¨äºæ„å»ºå‰ç«¯)
if ! command -v pnpm &> /dev/null; then
    echo "ğŸ“¦ æ­£åœ¨å…¨å±€å®‰è£… pnpm..."
    npm install -g pnpm
fi

echo "âœ… ä¾èµ–ç¯å¢ƒæ£€æŸ¥å®Œæ¯•ã€‚"

# 4. æ„å»ºå‰ç«¯ (app)
echo "------------------------------------------"
echo "ğŸ–¥ï¸  æ­£åœ¨æ„å»ºå‰ç«¯èµ„æº (Vue)..."
echo "------------------------------------------"
cd app
pnpm install
# å°† API æŒ‡å‘è‡ªèº«çš„æ ¹è·¯å¾„
echo "VITE_API_URL=/api" > .env.production
pnpm run build
cd ..

if [ ! -d "app/dist" ]; then
    echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥ï¼æ‰¾ä¸åˆ° app/dist ç›®å½•ã€‚"
    exit 1
fi
echo "âœ… å‰ç«¯æ„å»ºæˆåŠŸï¼"

# 5. å®‰è£…åç«¯ä¾èµ– (server)
echo "------------------------------------------"
echo "âš™ï¸  æ­£åœ¨å®‰è£…åå°ä¾èµ– (Express)..."
echo "------------------------------------------"
cd server
npm install --production

# 6. ä½¿ç”¨ PM2 å¯åŠ¨/é‡å¯åå°
echo "------------------------------------------"
echo "ğŸš€ æ­£åœ¨å¯åŠ¨/é‡å¯åå°å®ˆæŠ¤è¿›ç¨‹..."
echo "------------------------------------------"
# å¦‚æœ pm2 åˆ—è¡¨ä¸­å·²æœ‰ qin-server åˆ™é‡å¯ï¼Œå¦åˆ™æ–°å¯åŠ¨
pm2 restart qin-server || pm2 start src/index.js --name "qin-server"
pm2 save

echo "=========================================="
echo "ğŸ‰ éƒ¨ç½²å…¨éƒ¨å®Œæˆï¼ ğŸ‰"
echo "åå°è¿›ç¨‹å·²åœ¨ 3000 ç«¯å£å¯åŠ¨ï¼Œå¹¶ä¸”å·²ç»é…ç½®å¥½è‡ªåŠ¨æŒ‚è½½å‰ç«¯æ‰“åŒ…æ–‡ä»¶ï¼"
echo "ä½ å¯ä»¥é€šè¿‡ http://ä½ çš„æœåŠ¡å™¨IPåœ°å€:3000/ æ¥è®¿é—®å®Œæ•´çš„å‰åç«¯åº”ç”¨ã€‚"
echo "=========================================="
